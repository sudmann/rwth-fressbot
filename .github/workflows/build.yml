name: build-and-deploy
run-name: Build and Deploy
on: [push, workflow_dispatch]
jobs:
  build:
    name: Build (${{matrix.target}})
    runs-on: [ubuntu-latest]
    strategy:
      matrix:
        target:
          - aarch64-unknown-linux-gnu
    steps:
      - uses: actions/checkout@v3
      - name: Install rust toolchain for ${{matrix.target}}
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{matrix.target}}
      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
      - name: Build release for ${{matrix.target}}
        uses: actions-rs/cargo@v1
        with:
          use-cross: true
          command: build
          args: --release --target ${{matrix.target}} --features native-tls-vendored
      - uses: actions/upload-artifact@v4
        with:
          name: rwth-fressbot-${{matrix.target}}
          path: target/${{matrix.target}}/release/rwth-fressbot
          if-no-files-found: error
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: rwth-fressbot-aarch64-unknown-linux-gnu
      - name: Ensure connection
        run: ping6 -c 5 ${{ vars.RASPI_HOST }}
      - name: Copy binary to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ vars.RASPI_IP_LOCAL }}
          username: ${{ vars.RASPI_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_KEY_PASSPHRASE }}
          source: "rwth-fressbot"
          target: "/home/${{ vars.RASPI_USER }}/rwth-fressbot/artifacts"
      - name: Install binary
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ vars.RASPIHOST }}
          username: ${{ vars.RASPI_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_KEY_PASSPHRASE }}
          script: |
            cd /home/${{ vars.RASPI_USER }}/rwth-fressbot/artifacts
            sudo systemctl stop rwth-fressbot.service || echo "No instance of bot running"
            sudo install -D -m 755 -o root rwth-fressbot /bin
            sudo systemctl start rwth-fressbot.service
